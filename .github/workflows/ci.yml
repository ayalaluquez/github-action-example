name: CI

on:
  push:
    branches:
      - login-ecr
jobs:
  build:
    name: 'build'
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.ecr-credentials.outputs.token }}
    steps:
      - uses: actions/checkout@v1
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
          
      - name: Get AWS ECR credentials
        id: ecr-credentials
        run: |
          export TOKEN=$(aws ecr get-login-password --region us-west-2)
          echo $TOKEN
          echo ::set-output name=token::$TOKEN
          
      - name: Build, Tag, Push
        uses: whoan/docker-build-with-cache-action@v5
        with:
          registry: 103144140553.dkr.ecr.us-west-2.amazonaws.com
          image_name: build-test
          image_tag: test-ecr-login


  # Label of the container job
  test-job:
    needs: [build]
    if: success()
    # Containers must run in Linux based operating systems
    runs-on: ubuntu-latest
    # AWS ECR image that `test-job` executes in
    container:
      image: 103144140553.dkr.ecr.us-west-2.amazonaws.com:test-ecr-login
      credentials:
        username: AWS
        password: eyJwYXlsb2FkIjoibWU3bFRNZGdxblJwQmFnN0tjVEV3UjM4azREUU5OUU9KL3hNL25ucy91RjdMcURLZUltQ0Vac3VjdVZZbkNLQ0xuNk9EaTIrMmNQR205bXNwMWd3Slhnekw3c1h2cUYrUkgveUtNbEpSVGVLV1FDeWg3VGU3SEdQdUFYZ2JlSG5kdWk0YzN2Y3JKb0ZRZFRpQkVvQThhaTVwL0VNVzA1a21YRm5oMm5mZXNPWDJnaE9PNm81dGlmbGZTRU03dUJyd21ZbnAwaDZvSW55akw5djJiei9McGdkTGRzbEl0UEZKR09HR09BL0kwaktia3BXUTUzQXZsYjY2MlQxSHZURkY4bFNsQWVGQ1BuVjZRSnY4M04xeFcyaFcvWExFS0xWZzAwRFA3NXZQd1VtS1RZSWsxRFZKK2EyR1pzUWx1YlV1SEdPVmR4azN0UVRzTGtYZ2phVUREaGpVOHVhYU9pTmFTdFY0L1lnZVRGM2R6cUo0am9sZGZ1aWhqU2MraWJ4YWdBRVY4RENsUzMwNEViUXkrL0R5OUczaldidHB1eHRzSEMvSHB6VnNBMmVlNWVFdFNXMmlLTm5nYnpFYTZ6eGRWUFR4L1hVNEp6cEx2dW1CcGtnMmtjS0d2OCtUeGV1cERrNldEOVQ0U2V6K1VFZ1o4OERGY2lNbzdXS2l6T3VWSTcxa3pPcVV3UThzWDFOSlJsVmdtWW5GMGFKL1JXRnIvS0FiUzVvZGJBa2lMV3Y2ZDgyT2RDR21nbVg3NGxZKzg4VVJlRXNQS1V3WW40aHhlc1lFYUdJMG0ycTVVREdEQ1RxY3lxeURqdXdRTGlGZnp6eElEb3pNOFEwckFybWNocTUzMzlVYXQ5RkdJcnNHRHVzRjN2bnNRZ1pNVVpicHFaVlE3OVVPajlTYUJWTGxGZFhuVjdXRnRwNmN5RWg3VE9XbWxzSzNoVkJMSEFZV0NvcHEzRXFPb0ZFZEttRWVsL01ROFhNSmJPb3NScUNFZmJrbVJKYktURVRDUjRKTEJTS3M3clJ1cWVTOVdRaDhIQzZ4T1JNZzVSdHcrYkhuS2xYRVNKdnFSSjRDZHR0T21jVkovSy96RGsvMTk5ZnlZQWxTeTcyLzVWWmRXRDFlKzJtUTVUc2FaSHk3MUtGK3BkcXpDSUxaKzU5RG1LRU02a05GQmVwUVlYSmloRHZsQzl3K3BSZE05WURBamlKTTFpbUZPMlo3bTRBSDB0R1BGWDhpZ0xIc2RZNDQzTXFlcWhUSWZaMnZVMjhDdkFBYVJlWkUvOXVOUGdFQktBbG1UU2FJL3k0Y2pkbEVscFJSc0pmVXhROGVqcWYwMVI4U2syVG82Q2JCamJUR0FLeG4yWG1Tck1JcEJWckRQMFM2ZHNpZy8rWUpFSnNFd3BPNXBBR0o5aXVGdDV6S05BWXZOb3NTbFdoZnE4K2VLUzI3aFJEeVVONzBjRUEiLCJkYXRha2V5IjoiQVFFQkFIajZsYzRYSUp3LzdsbjBIYzAwRE1lazZHRXhIQ2JZNFJJcFRNQ0k1OEluVXdBQUFINHdmQVlKS29aSWh2Y05BUWNHb0c4d2JRSUJBREJvQmdrcWhraUc5dzBCQndFd0hnWUpZSVpJQVdVREJBRXVNQkVFRE5rZENVZHNVN1lpUElxS0lnSUJFSUE3aUlYaGN0V0twZVpkaTA1dkkxRzc2UkJXUkp5Y3g1K2xhRmVVVmlHS0k0SENnNkdra3dRQ0sraUxrVkdwVUxXZGxxbmZ6cDJ2UlZFaWRBMD0iLCJ2ZXJzaW9uIjoiMiIsInR5cGUiOiJEQVRBX0tFWSIsImV4cGlyYXRpb24iOjE2MjEwMDA2MTl9

    steps:
      
      - name: Check out repository code
        run:
          echo '${{ needs.build.outputs.token }}'

          
